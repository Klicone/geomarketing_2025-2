---
title: "trabajo1_idg_licon"
author: "Kevin Licón"
date: "`r Sys.Date()`"
output: html_document
---

# 1. Introducción

::: {style="text-align: justify;"}
El territorio se transforma constantemente a medida que cambian las relaciones sociales, las políticas públicas y las dinámicas del mercado. En la Provincia de Valparaíso, estos procesos se expresan a través de una geografía desigual, donde la estructura metropolitana combina sectores con alta concentración de bienes y servicios -como Valparaíso y Viña del Mar- y otras que dependen de ellas para acceder a educación, salud y empleo.

La movilidad intercomunal permite comprender el grado de integración funcional entre estos territorios. Los desplazamientos generalmente responden a diferentes variables y contextos, de acuerdo a las diferentes realidades de la población. Habitualmente se tiende a pensar únicamente en la migración desde lo rural a lo urbano, pero resulta imperioso observar cómo han cambiado estas dinámicas, aún más después del fenómeno de la pandemia del COVID-19, donde las personas cambiaron algunas tendencias, movilizándose a zonas alejadas de la urbe con las nuevas posibilidades que presentaba el trabajo telemático. Este último fenómeno se observó principalmente en personas con estudios superiores, los cuales en varios casos las labores que realizan son llevadas a cabo a través de un computador. También es importante considerar las necesidades de las nuevas generaciones, donde alejarse de las zonas más aglomeradas se convierte en una tendencia cada vez mayor, pero a la vez esto no implica que esta población quiera renunciar a la accesibilidad en bienes y servicios propios de las zonas más urbanizadas.

A su vez, resulta interesante estudiar como variable la educación superior de la población, donde aparecen fenómenos esperables como una distribución espacial que no es uniforme: las zonas con alta concentración de población con estudios superiores suelen ser también las que experimentan procesos de renovación urbana o gentrificación, donde la llegada de nuevos habitantes con mayor nivel educativo y, por consecuencia, de ingresos mayores, reconfigura el tejido social y el uso del territorio.

En este contexto, el presente estudio busca analizar la relación entre la movilidad intercomunal y el nivel educativo en la Provincia de Valparaíso, observando cómo ambas dimensiones se entrelazan para reflejar las problemáticas planteadas. A partir de los datos obtenidos del Censo 2017, se busca identificar los territorios donde estas variables convergen, revelando las posibles tendencias de reconfiguración social y territorial dentro del sistema metropolitano porteño.

Este enfoque permite vincular las variables a través de un análisis bivariado, el cual contribuye a comprender como la educación y movilidad se combinan en los procesos contemporáneos de cambio urbano, en los que la gentrificación aparece como una manifestación de las nuevas formas de desigualdad espacial en el territorio.
:::

# 2. Objetivos

## 2.1. Objetivo General

::: {style="text-align: justify;"}
Analizar la relación entre la movilidad intercomunal residencial y la población con educación superior en la Provincia de Valparaíso, con el propósito de identificar patrones territoriales asociados a procesos de reconfiguración urbana y posibles manifestaciones de gentrificación.
:::

## 2.2. Objetivos Específicos

::: {style="text-align: justify;"}
1.  Caracterizar espacialmente la distribución de población con estudios superiores y la movilidad intercomunal residencial.

2.  Explorar la relación estadística entre ambas variables, identificando tendencias generales y posibles asociaciones significativas.

3.  Elaborar representaciones cartográficas bivariadas que integren ambas dimensiones, permitiendo visualizar los contrastes.

4.  Interpretar los resultados desde una perspectiva territorial, relacionando los patrones observados con fenómenos contemporáneos como la redistribución residencial, valorización urbana y gentrificación.
:::

# 3. Metodología

::: {style="text-align: justify;"}
El análisis se desarrolló principalmente bajo un enfoque cuantitativo y espacial, orientado a examinar la relación entre la movilidad intercomunal y el nivel educativo de la población en la Provincia de Valparaíso. Se utilizó información proveniente del Censo 2017, procesada mediante R y datos almacenados en una base PostgreSQL/PostGIS, complementando el análisis estadístico con técnicas de visualización cartográfica. A continuación se desarrollarán aspectos metodológicos destacables del proceso.

## 3.1 Librerías

Para la realización del trabajo se utilizó como entorno de programación R (versión 4.5.1), complementando con un conjunto de librerías que permiten la conexión a bases de datos, manipulación de datos espaciales y visualización estadística.

```{r librerias, echo=TRUE, message=FALSE, warning=FALSE}
library(DBI)
library(RPostgres)
library(sf)
library(ggplot2)
library(RColorBrewer)
library(cowplot)
library(biscale)
```

Estas herramientas logran obtener un flujo de análisis más acabado, desde la conexión a la base de datos hasta la generación de representaciones cartográficas.

## 3.2 Conexión Base de Datos

Los datos provenientes del Censo 2017 fueron almacenados en una base de datos PostgreSQL, donde además se añadió la extensión PostGIS, la cual permite el manejo de geometrías espaciales. Dicho complemento fue necesario para poder espacializar los datos del censo, por lo cual a partir de archivos *geojson* cargados en el software QGIS, se incorpora una conexión con la base de datos con información geométrica.

La conexión con R se estableció mediante el paquete `RPostgres` con parámetros locales de host, puerto, usuario, contraseña y nombre de la base de datos, como se muestra a continuación:

```{r conexion datos db, message=FALSE, warning=FALSE, include=FALSE}
db_host = 'localhost'
db_port = 5432
db_name = 'censo_v_2017'
db_user = 'postgres'
db_password = 'postgres'
```

```{r conexion db, echo=TRUE, message=FALSE, warning=FALSE}
con = dbConnect(
  Postgres(),
  dbname = db_name,
  host = db_host,
  port = db_port,
  user = db_user,
  password = db_password
)
```

A partir de esta conexión se ejecutaron consultas SQL que permitieron obtener la siguiente información:

-   Zonas censales con sus geometrías.

-   La tabla de indicadores demográficos.

-   Capa de límites comunales para referencia visual.

El almacenamiento a través del gestor de bases de datos permitió realizar cruces de información espacial de una forma eficiente y mantener a su vez la consistencia geométrica.

## 3.3 Indicadores

Para la realización del estudio se construyeron dos indicadores a partir de los datos del Censo de Población y Vivienda 2017, los cuales fueron expresados en porcentaje.

### 3.3.1 Porcentaje de Movilidad Intercomunal Residencial (MIR)

Este indicador tiene como propósito cuantificar la proporción de personas que, en el momento del Censo 2017, residían en una comuna diferente a la actual cinco años antes del levantamiento censal.

A través de este indicador se pueden representar los cambios de residencia habitual entre comunas, asociado a procesos de redistribución poblacional.

$$
\text{MIR (%)} =
\left(
\frac{P_{\text{migrantes}}}{P_{\text{total}}}
\right) \times 100
$$

Donde:

$P_{\text{migrantes}}$ = personas que cambiaron de comuna en los últimos cinco años. Las variables consideradas del censo son: `p10`, que toma el valor de `1` para aquellas personas que fueron censadas en su residencia habitual; y `p11`, que indica cuando la persona residía en otra comuna en los últimos 5 años cuando toma el valor de `3`.

$P_{\text{total}}$ = población total de la zona censal.

A continuación, se presenta la parte de la query en `SELECT` que invoca al indicador:

``` {.SQL style="color:blue"}
ROUND(
    COUNT(*) FILTER (
        WHERE p.p10 = 1
        AND p.p11 = 3
    ) * 100.0 / COUNT(*), 2)
    AS ptje_mov_intercomunal
```

### 3.3.2 Porcentaje de Población con Educación Superior (PES)

Por otra parte, este indicador representa la proporción de personas con educación técnica o universitaria completa o incompleta, en relación con el total de población censada en cada zona.

$$
\text{PES (%)} =
\left(
\frac{P_{\text{ed_sup}}}{P_{\text{total}}}
\right) \times 100
$$

$P_{\text{ed_sup}}$ = número de personas que declararon haber cursado estudios de nivel técnico o universitario. En este caso se consideró a la población mayor de edad a través de la variable censal `p09`, mientras que la variable correspondiente a años de estudios `escolaridad` se filtraron aquellos valores iguales o superiores a 13, ya que en Chile la educación básica y media tiene una duración de 12 años.

$P_{\text{total}}$ = población total residente mayor de edad en la zona censal.

A continuación, se presenta el `SELECT` en la query que contempla este indicador:

``` {.SQL style="color:blue"}
ROUND(
    COUNT(*) FILTER (
        WHERE p.p09 >= 18
        AND p.escolaridad >= 13
    ) * 100.0 / COUNT(*) FILTER (
        WHERE p.p09 >= 18
    ), 2)
    AS ptje_ed_superior
```

```{r query, message=FALSE, warning=FALSE, include=FALSE}
sql_indicadores = "
WITH agg AS (
  SELECT 
	z.geocodigo::double precision AS geocodigo,
	c.nom_comuna,

	ROUND(
	COUNT(*) FILTER (
		WHERE p.p10 = 1 	-- Comuna de residencia habitual en la actual
		AND p.p11 = 3 		-- Comuna de residencia anterior en otra
	) * 100.0 / COUNT(*), 2)
	AS ptje_mov_intercomunal,

	ROUND(
	COUNT(*) FILTER (
		WHERE p.p09 >= 18
		AND p.escolaridad >= 13
	) * 100.0 / COUNT(*) FILTER (
		WHERE p.p09 >= 18
	), 2)
	AS ptje_ed_superior

  FROM public.personas AS p
  
  JOIN public.hogares AS h ON p.hogar_ref_id = h.hogar_ref_id
  JOIN public.viviendas AS v ON h.vivienda_ref_id = v.vivienda_ref_id
  JOIN public.zonas AS z ON v.zonaloc_ref_id = z.zonaloc_ref_id
  JOIN public.comunas AS c ON z.codigo_comuna = c.codigo_comuna
  JOIN public.provincias AS pr ON c.provincia_ref_id = pr.provincia_ref_id
  
  WHERE pr.nom_provincia = 'VALPARAÍSO'
    AND c.nom_comuna <> 'JUAN FERNÁNDEZ'
  GROUP BY z.geocodigo, c.nom_comuna
),
-- Partes continentales (mayor área) por comuna
comunas_mainland AS (
  WITH partes AS (
    SELECT nom_comuna, (ST_Dump(geom)).geom AS geom
    FROM dpa.comunas_v
    WHERE nom_provin = 'VALPARAÍSO'
      AND nom_comuna <> 'JUAN FERNÁNDEZ'
  ),
  ranked AS (
    SELECT nom_comuna, geom,
           ROW_NUMBER() OVER (
             PARTITION BY nom_comuna
             ORDER BY ST_Area(ST_Transform(geom, 32719)) DESC
           ) AS rn
    FROM partes
  )
  SELECT nom_comuna, geom
  FROM ranked
  WHERE rn = 1
),
-- Máscara continental (una sola geometría)
mainland AS (
  SELECT ST_Union(geom) AS geom
  FROM comunas_mainland
)
SELECT
  a.geocodigo,
  shp.geom,
  a.nom_comuna,
  a.ptje_mov_intercomunal,
  a.ptje_ed_superior
FROM agg a
JOIN dpa.zonas_censales_v AS shp
  ON a.geocodigo = shp.geocodigo
JOIN mainland m
  ON ST_Intersects(shp.geom, m.geom);  -- deja fuera zonas insulares

;

"
```

Ambos indicadores fueron calculados en R y almacenados en formato porcentual. Posteriormente se aplicaron gráficos estadísticos y se analizaron de forma conjunta.

```{r dataframe, message=FALSE, warning=FALSE, include=FALSE}
df_indicadores = st_read(con, query = sql_indicadores)
```

## 3.4 Desagregación Espacial

La unidad de análisis de realizó a nivel de zona censal, la cual permite captar con mayor detalle las diferencias intracomunales y los contrastes entre áreas urbanas, periurbanas y rurales.

La elección se fundamenta principalmente en la capacidad para reflejar las variaciones internas dentro de cada comuna, especialmente en un territorio complejo con es la provincia de Valparaíso.

Durante la etapa de preparación espacial, se identificó una problemática asociada a las zonas insulares pertenecientes a algunas comuna de la provincia. Si bien existe el caso de Rapa Nui y Juan Fernández, ambos casos insulares son comunas por si sola que se pueden filtrar rápidamente. Caso contrario ocurre con las Islas Salas y Gomez, las cuales pertenecen administrativamente al territorio continental de Valparaíso. Estas porciones, al ser geométricamente discontínuas y carentes de población censada, generaban interferencias en los procesos de intersección espacial y en la eventual visualización de los resultados cartográficos.

Para abordar dicha situación, se implemento un filtro espacial mediante SQL, cuyo propósito principal fue mantener únicamente las partes continentales de cada comuna, seleccionado el polígono de mayor tamaño y excluyendo las zonas insulares.

``` {.SQL style="color:blue"}
comunas_mainland AS (
  WITH partes AS (
    SELECT nom_comuna, (ST_Dump(geom)).geom AS geom
    FROM dpa.comunas_v
    WHERE nom_provin = 'VALPARAÍSO'
      AND nom_comuna <> 'JUAN FERNÁNDEZ'
  ),
  ranked AS (
    SELECT nom_comuna, geom,
           ROW_NUMBER() OVER (
             PARTITION BY nom_comuna
             ORDER BY ST_Area(ST_Transform(geom, 32719)) DESC
           ) AS rn
    FROM partes
  )
  SELECT nom_comuna, geom
  FROM ranked
  WHERE rn = 1
),

mainland AS (
  SELECT ST_Union(geom) AS geom
  FROM comunas_mainland
)
SELECT
  a.geocodigo,
  shp.geom,
  a.nom_comuna,
  a.ptje_mov_intercomunal,
  a.ptje_ed_superior
FROM agg a
JOIN dpa.zonas_censales_v AS shp
  ON a.geocodigo = shp.geocodigo
JOIN mainland m
  ON ST_Intersects(shp.geom, m.geom);
```

```{r comunas, message=FALSE, warning=FALSE, include=FALSE}
sql_comunas = "

WITH partes AS (
  SELECT
    nom_comuna,
    (ST_Dump(geom)).geom AS geom
  FROM dpa.comunas_v
  WHERE nom_provin = 'VALPARAÍSO'
    AND nom_comuna <> 'JUAN FERNÁNDEZ'
),
ranked AS (
  SELECT
    nom_comuna,
    geom,
    ROW_NUMBER() OVER (
      PARTITION BY nom_comuna
      ORDER BY ST_Area(ST_Transform(geom, 32719)) DESC
    ) AS rn
  FROM partes
)
SELECT nom_comuna, geom
FROM ranked
WHERE rn = 1;   -- solo la parte continental (mayor área) por comuna
;

"
```

```{r geometria, message=FALSE, warning=FALSE, include=FALSE}
sf_comunas = st_read(con, query = sql_comunas)

sf_centroides = st_centroid(sf_comunas)
```

## 3.5 Visualización
:::

# 4. Resultados y Análisis

```{r histograma var 1, echo=FALSE, message=FALSE, warning=FALSE}
# HISTOGRAMA DISTRIBUCIÓN DEL % DE MOVILIDAD INTERCOMUNAL
ggplot(df_indicadores, aes(x = ptje_mov_intercomunal)) +
  geom_histogram(bins = 30, fill = '#226e6e', color = 'white') +
  labs(title = 'Distribución del % de Movilidad Intercomunal',
       x = '% de Movilidad Intercomunal',
       y = 'Frecuencia')
```

```{r histograma var 2, echo=FALSE, message=FALSE, warning=FALSE}
# HISTOGRAMA DISTRIBUCIÓN DEL % DE EDUCACIÓN SUPERIOR
ggplot(df_indicadores, aes(x = ptje_ed_superior)) +
  geom_histogram(bins = 30, fill = '#6e6b22', color = 'white') +
  labs(title = "Distribución del % de Educación Superior",
       x = "% de Educación Superior",
       y = "Frecuencia")
```

```{r dispersion, echo=FALSE, message=FALSE, warning=FALSE}
# DIAGRAMA DE DISPERSIÓN
ggplot(df_indicadores, aes(x = ptje_mov_intercomunal, y = ptje_ed_superior)) +
  geom_point(color = "steelblue") +
  labs(title = 'Relación entre % de Movilidad Intercomunal vs. % escolaridad',
       x = '% de Movilidad Intercomunal',
       y = '% de Educación Superior') +
theme_minimal()
```

```{r mapa var 1, echo=FALSE, message=FALSE, warning=FALSE}
# MAPA % DE MOVILIDAD INTERCOMUNAL POR ZONA CENSAL
ggplot() +
  geom_sf(data = df_indicadores, aes(fill = ptje_mov_intercomunal), color = NA) +
  geom_sf(data = sf_comunas, fill = NA, color = "black", size = 1) +
  geom_sf_text(data = sf_centroides, aes(label = nom_comuna),
               size = 3, fontface = "bold") +
  scale_fill_distiller(palette = "BuPu", name = "% de Movilidad Intercomunal", direction = 1) +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "% de Movilidad Intercomunal por zona censal",
       subtitle = "Provincia de VALPARAÍSO")
```

```{r mapa var 2, echo=FALSE, message=FALSE, warning=FALSE}
# MAPA % DE EDUCACIÓN SUPERIOR POR ZONA CENSAL
ggplot() +
  geom_sf(data = df_indicadores, aes(fill = ptje_ed_superior), color = NA) +
  geom_sf(data = sf_comunas, fill = NA, color = "black", size = 1) +
  geom_sf_text(data = sf_centroides, aes(label = nom_comuna),
               size = 3, fontface = "bold") +
  scale_fill_distiller(palette = "BuPu", name = "% de Educación Superior", direction = 1) +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "% de Educación Superior por zona censal",
       subtitle = "Provincia de VALPARAÍSO")
```

```{r bivariado, echo=FALSE, message=FALSE, warning=FALSE}
sf_mapa_bi = bi_class(
  df_indicadores,
  x = ptje_mov_intercomunal,
  y = ptje_ed_superior,
  dim = 3,
  style = "jenks"
)


mapa_bivariado = ggplot() +
  geom_sf(data = sf_mapa_bi, aes(fill = bi_class), color = NA, show.legend = FALSE) +
  geom_sf(data = sf_comunas, fill = NA, color = "black", size = 1) +
  geom_sf_text(data = sf_centroides, aes(label = nom_comuna),
               size = 3, fontface = "bold") +
  bi_scale_fill(pal = "DkBlue", dim = 3) +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5)) +
  labs(title = "Mapa Bivariado: % de Movilidad Intercomunal vs % de Educación Superior",
       subtitle = "Provincia de VALPARAÍSO")


leyenda_bivariada = bi_legend(
  pal = "DkBlue", 
  dim = 3,
  xlab = "% de Movilidad Intercomunal (bajo → alto)",
  ylab = "% de Educación Superior (bajo → alto)",
  size = 5
)

mapa_final = ggdraw() +
  draw_plot(mapa_bivariado, x = 0,    y = 0,    width = 1,    height = 1) +
  draw_plot(leyenda_bivariada,        x = 0.72, y = 0.05, width = 0.26, height = 0.26)
print(mapa_final)

```

# 5. Conclusiones

# 6. Bibliografía
